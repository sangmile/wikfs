# 쿠버네티스 애플리케이션 개발

쿠버네티스 애플리케이션을 개발할 때 참고할 만한 사항들이다.

## 외부에서 애플리케이션 실행

### 백엔드 서비스 연결 방법 

`BACKEND_SERVICE_HOST` 와 `BACKEND_SERVICE_PORT`환경변수를 사용한다면 로컬 시스템에서 해당 환경변수를 수동으로 설정하여 개발한다. 쿠버네티스 클러스터에서 실행 중인 경우 서비스를 NodePort 또는 LoadBalancer 타입 서비스로 변경하여 외부에서 액세스할 수 있게 한다.

### API 서버에 연결하는 방법

쿠버네티스 API 서버에 액세스해야 하는 경우 아래 케이스가 있을 수 있다.

* 서비스어카운트의 토큰을 사용해 자체 인증하는 경우 kubectl cp를 사용해 서비스어카운트의 시크릿 파일을 로컬에 복사한다.

### 이미지를 생성하지 않고 바이너리 파일을 도커 볼륨으로 마운트하기

도커 볼륨으로 로컬 파일시스템을 컨테이너에 마운트할 수 있다. 바이너리의 새 버전을 빌드한 후에 컨테이너를 재시작하기만 하면 된다.

## Minikube 사용

개발 중에 쿠버네티스 내에 애플리케이션을 실행할 필요는 없지만 쿠버네티스 환경에서 확인하는 것이 좋다.

### 로컬 컨테이너에 로컬 파일 마운트

minikube mount 명령을 사용해 로컬 파일시스템을 Minikube 가상머신에 마운트한 다음 hostPath로 컨테이너로 마운트할 수 있다.

### Minikube 도커 데몬으로 빌드 

컨테이너 이미지를 빌드하려는 경우 Minikube 내부의 도커 데몬을 사용해 이미지를 빌드하면 로컬 도커 데몬을 통해 이미지를 빌드할 필요가 없다. Minikube의 도커 데몬을 사용하려면 `DOCKER_HOST` 환경변수를 지정하기만 하면 된다. 다음 명령을 사용한다.

```text
$ eval $(minikube docker-env)
```

이미지를 빌드하면 이미지가 Minikube 가상머신의 로컬로 저장되어 있다.

### 로컬에서 이미지를 빌드하고 Minikube로 복사

Minikube 내부의 도커 데몬을 사용할 수 없는 경우 이미지를 레지스트리에 푸시하지 않고, Minikube에서 실행 중인 kubelet에서 이미지를 가져올 수 있다. 다음 명령을 사용해 로컬에서 빌드한 이미지를 minikube로 복사할 수 있다.

```text
$ docker save <image> | (eval $(minikube docker-env) && docker load)
```

이러한 방법을 사용할 때에는 imagePullPolicy가 Always로 설정되어 있으면 안된다.

### 적절한 클러스터와 minikube 결합

